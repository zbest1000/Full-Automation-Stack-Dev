{
  "version": "2",
  "templates": [
    {
      "type": "stack",
      "title": "Industrial Automation Stack via Tailscale",
      "name": "industrial-automation-stack-tailscale",
      "description": "Complete industrial automation toolkit with Node-RED, FlowFuse, HiveMQ, Ignition, TimeBase, MonsterMQ, Grafana, InfluxDB, PostgreSQL, and Redis. All services are exposed exclusively via Tailscale sidecar with userspace networking only. No host ports are published.",
      "note": "⚠️ IMPORTANT: Provide a valid Tailscale auth key (TS_AUTHKEY) before deploying. All services listen only on the private Docker network and are reachable through Tailscale serve mappings. The Portainer service is included for bare Docker hosts but MUST be removed/disabled when deploying from an existing Portainer instance.",
      "categories": [
        "automation",
        "iot",
        "network",
        "monitoring",
        "industrial"
      ],
      "platform": "linux",
      "logo": "https://portainer-io-assets.s3.amazonaws.com/logos/portainer.png",
      "env": [
        {
          "name": "TS_AUTHKEY",
          "label": "Tailscale Auth Key",
          "description": "Reusable or ephemeral auth key that allows the stack to join your tailnet. Store securely.",
          "default": "",
          "required": true
        },
        {
          "name": "TAILSCALE_HOSTNAME",
          "label": "Tailscale Hostname",
          "description": "Hostname to register inside the tailnet.",
          "default": "automation-stack"
        },
        {
          "name": "POSTGRES_USER",
          "label": "PostgreSQL User",
          "description": "Database user for PostgreSQL service.",
          "default": "flowfuse"
        },
        {
          "name": "POSTGRES_PASSWORD",
          "label": "PostgreSQL Password",
          "description": "Database password for PostgreSQL service.",
          "default": ""
        },
        {
          "name": "POSTGRES_DB",
          "label": "PostgreSQL Database",
          "description": "Default database name for PostgreSQL service.",
          "default": "flowfuse"
        },
        {
          "name": "GRAFANA_ADMIN_USER",
          "label": "Grafana Admin User",
          "description": "Initial admin username for Grafana.",
          "default": "admin"
        },
        {
          "name": "GRAFANA_ADMIN_PASSWORD",
          "label": "Grafana Admin Password",
          "description": "Initial admin password for Grafana.",
          "default": ""
        },
        {
          "name": "INFLUXDB_ADMIN_USER",
          "label": "InfluxDB Admin User",
          "description": "Bootstrap admin user for InfluxDB 2.x.",
          "default": "admin"
        },
        {
          "name": "INFLUXDB_ADMIN_PASSWORD",
          "label": "InfluxDB Admin Password",
          "description": "Bootstrap admin password for InfluxDB 2.x.",
          "default": ""
        },
        {
          "name": "INFLUXDB_BUCKET",
          "label": "InfluxDB Bucket",
          "description": "Default bucket name created during bootstrap.",
          "default": "automation"
        },
        {
          "name": "INFLUXDB_ORG",
          "label": "InfluxDB Organization",
          "description": "Default organization name created during bootstrap.",
          "default": "automation"
        },
        {
          "name": "INFLUXDB_RETENTION",
          "label": "InfluxDB Retention (hours)",
          "description": "Retention policy duration (in hours) for the bootstrap bucket. 0 = infinite.",
          "default": "0"
        },
        {
          "name": "HIVEMQ_ALLOW_ANONYMOUS",
          "label": "HiveMQ Allow Anonymous",
          "description": "Enable anonymous MQTT connections (true/false).",
          "default": "true"
        },
        {
          "name": "HIVEMQ_USER",
          "label": "HiveMQ Username",
          "description": "Optional MQTT username for HiveMQ authentication.",
          "default": ""
        },
        {
          "name": "HIVEMQ_PASSWORD",
          "label": "HiveMQ Password",
          "description": "Optional MQTT password for HiveMQ authentication.",
          "default": ""
        },
        {
          "name": "MONSTERMQ_DB_URL",
          "label": "MonsterMQ Database URL",
          "description": "Database connection URL for MonsterMQ (e.g., postgresql://host:5432/dbname).",
          "default": ""
        },
        {
          "name": "MONSTERMQ_DB_USER",
          "label": "MonsterMQ Database User",
          "description": "Database user for MonsterMQ.",
          "default": ""
        },
        {
          "name": "MONSTERMQ_DB_PASSWORD",
          "label": "MonsterMQ Database Password",
          "description": "Database password for MonsterMQ.",
          "default": ""
        },
        {
          "name": "MONSTERMQ_TCP_PORT",
          "label": "MonsterMQ MQTT TCP Port",
          "description": "MQTT TCP port for MonsterMQ (internal).",
          "default": "1883"
        },
        {
          "name": "MONSTERMQ_TLS_PORT",
          "label": "MonsterMQ MQTT TLS Port",
          "description": "MQTT TLS port for MonsterMQ (internal).",
          "default": "8883"
        },
        {
          "name": "MONSTERMQ_WS_PORT",
          "label": "MonsterMQ WebSocket Port",
          "description": "WebSocket port for MonsterMQ (internal).",
          "default": "9000"
        },
        {
          "name": "MONSTERMQ_WSS_PORT",
          "label": "MonsterMQ WebSocket Secure Port",
          "description": "WebSocket Secure port for MonsterMQ (internal).",
          "default": "9001"
        },
        {
          "name": "MONSTERMQ_OPCUA_PORT",
          "label": "MonsterMQ OPC UA Port",
          "description": "OPC UA port for MonsterMQ (internal).",
          "default": "4840"
        },
        {
          "name": "MONSTERMQ_GRAPHQL_PORT",
          "label": "MonsterMQ GraphQL Port",
          "description": "GraphQL API port for MonsterMQ (internal).",
          "default": "4000"
        }
      ],
      "composeFile": "version: '3.9'\nname: automation-stack\nservices:\n  tailscale:\n    image: tailscale/tailscale:stable\n    hostname: \"${TAILSCALE_HOSTNAME}\"\n    environment:\n      TS_AUTHKEY: ${TS_AUTHKEY}\n    volumes:\n      - tailscale-state:/var/lib/tailscale\n    networks:\n      - automation\n    command:\n      - /bin/sh\n      - -c\n      - |\n        if [ -z \"${TS_AUTHKEY}\" ]; then\n          echo 'ERROR: TS_AUTHKEY must be provided' >&2\n          exit 1\n        fi\n        tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/tmp/tailscaled.sock --tun=userspace-networking &\n        TAILSCALED_PID=$!\n        until tailscale --socket=/tmp/tailscaled.sock status >/dev/null 2>&1; do\n          sleep 0.5\n        done\n        tailscale --socket=/tmp/tailscaled.sock up --authkey=${TS_AUTHKEY} --hostname=${TAILSCALE_HOSTNAME} --ssh\n        tailscale --socket=/tmp/tailscaled.sock serve reset\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 80 flowfuse:3000\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 1880 node-red:1880\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 1883 hivemq:1883\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 1884 hivemq-edge:1883\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 1885 monstermq:1883\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 8088 ignition:8088\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 8885 monstermq:8883\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9000 monstermq:9000\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9001 monstermq:9001\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 4840 monstermq:4840\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 4000 monstermq:4000\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9002 timebase:8011\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9003 timebase:8013\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9004 timebase-historian:8011\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9005 timebase-historian:8013\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9086 influxdb:8086\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9090 grafana:3000\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 5432 postgres:5432\n        tailscale --socket=/tmp/tailscaled.sock serve --bg tcp 9443 portainer:9443\n        wait $TAILSCALED_PID\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"tailscale\", \"--socket=/tmp/tailscaled.sock\", \"status\", \"--json\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  postgres:\n    image: postgres:15-alpine\n    environment:\n      POSTGRES_USER: ${POSTGRES_USER}\n      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}\n      POSTGRES_DB: ${POSTGRES_DB}\n    volumes:\n      - postgres-data:/var/lib/postgresql/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U ${POSTGRES_USER}\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  redis:\n    image: redis:7-alpine\n    command: redis-server --save 60 1 --loglevel warning\n    volumes:\n      - redis-data:/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD\", \"redis-cli\", \"ping\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  flowfuse:\n    image: flowfuse/flowfuse:latest\n    depends_on:\n      postgres:\n        condition: service_healthy\n      redis:\n        condition: service_healthy\n    environment:\n      FF_PROJECTS_DIR: /var/lib/flowfuse\n      FF_STORAGE__TYPE: localfs\n      FF_DB__CLIENT: pg\n      FF_DB__PG__HOST: postgres\n      FF_DB__PG__USER: ${POSTGRES_USER}\n      FF_DB__PG__PASSWORD: ${POSTGRES_PASSWORD}\n      FF_DB__PG__DATABASE: ${POSTGRES_DB}\n      FF_REDIS__HOST: redis\n    volumes:\n      - flowfuse-data:/var/lib/flowfuse\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:3000/ || exit 1\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  node-red:\n    image: nodered/node-red:3.1\n    environment:\n      NODE_RED_ENABLE_PROJECTS: \"true\"\n    volumes:\n      - node-red-data:/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:1880/ || exit 1\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  monstermq:\n    image: rocworks/monstermq:latest\n    environment:\n      MONSTERMQ_DB_URL: ${MONSTERMQ_DB_URL}\n      MONSTERMQ_DB_USER: ${MONSTERMQ_DB_USER}\n      MONSTERMQ_DB_PASSWORD: ${MONSTERMQ_DB_PASSWORD}\n      MONSTERMQ_TCP_PORT: ${MONSTERMQ_TCP_PORT}\n      MONSTERMQ_TLS_PORT: ${MONSTERMQ_TLS_PORT}\n      MONSTERMQ_WS_PORT: ${MONSTERMQ_WS_PORT}\n      MONSTERMQ_WSS_PORT: ${MONSTERMQ_WSS_PORT}\n      MONSTERMQ_OPCUA_PORT: ${MONSTERMQ_OPCUA_PORT}\n      MONSTERMQ_GRAPHQL_PORT: ${MONSTERMQ_GRAPHQL_PORT}\n    volumes:\n      - monstermq-config:/app/config\n      - monstermq-log:/app/log\n      - monstermq-security:/app/security\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"nc -z localhost 1883 || (wget -qO- http://localhost:4000/graphql 2>/dev/null | grep -q 'graphql' && exit 0 || exit 1)\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  hivemq:\n    image: hivemq/hivemq-ce:latest\n    environment:\n      HIVEMQ_ALLOW_ANONYMOUS: ${HIVEMQ_ALLOW_ANONYMOUS}\n      HIVEMQ_USER: ${HIVEMQ_USER}\n      HIVEMQ_PASSWORD: ${HIVEMQ_PASSWORD}\n    volumes:\n      - hivemq-data:/opt/hivemq/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"nc -z localhost 1883\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  hivemq-edge:\n    image: hivemq/hivemq-edge:latest\n    volumes:\n      - hivemq-edge-data:/opt/hivemq-edge/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"nc -z localhost 1883\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  ignition:\n    image: kcollins/ignition:8.1\n    environment:\n      ACCEPT_EULA: \"Y\"\n    volumes:\n      - ignition-data:/usr/local/share/ignition/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"nc -z localhost 8088 || (wget -qO- http://localhost:8088/main/system/health 2>/dev/null | grep -q 'health' && exit 0 || exit 1)\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  timebase:\n    image: finos/timebase-server:6.1\n    environment:\n      TB_HEAP: 2G\n    volumes:\n      - timebase-data:/timebase\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"nc -z localhost 8011\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  timebase-historian:\n    image: finos/timebase-server:6.1\n    environment:\n      TB_HEAP: 2G\n    volumes:\n      - timebase-historian-data:/timebase\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"nc -z localhost 8011\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  influxdb:\n    image: influxdb:2.7\n    environment:\n      DOCKER_INFLUXDB_INIT_MODE: setup\n      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUXDB_ADMIN_USER}\n      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUXDB_ADMIN_PASSWORD}\n      DOCKER_INFLUXDB_INIT_ORG: ${INFLUXDB_ORG}\n      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUXDB_BUCKET}\n      DOCKER_INFLUXDB_INIT_RETENTION: ${INFLUXDB_RETENTION}\n    volumes:\n      - influxdb-data:/var/lib/influxdb2\n      - influxdb-config:/etc/influxdb2\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:8086/health || exit 1\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  grafana:\n    image: grafana/grafana:10.4.3\n    environment:\n      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER}\n      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}\n    volumes:\n      - grafana-data:/var/lib/grafana\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:3000/login || exit 1\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n  portainer:\n    image: portainer/portainer-ce:latest\n    command: -H unix:///var/run/docker.sock\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock\n      - portainer-data:/data\n    networks:\n      - automation\n    restart: unless-stopped\n    healthcheck:\n      test: [\"CMD-SHELL\", \"wget -qO- http://localhost:9443/api/status || exit 1\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\nnetworks:\n  automation:\n    driver: bridge\nvolumes:\n  tailscale-state:\n  postgres-data:\n  redis-data:\n  flowfuse-data:\n  node-red-data:\n  monstermq-config:\n  monstermq-log:\n  monstermq-security:\n  hivemq-data:\n  hivemq-edge-data:\n  ignition-data:\n  timebase-data:\n  timebase-historian-data:\n  influxdb-data:\n  influxdb-config:\n  grafana-data:\n  portainer-data:\n"
    }
  ]
}